name: Initialize Model
description: Initializes the RNN model.
inputs:
  - {name: config, type: String}
  - {name: weights_url, type: String}
outputs:
  - {name: model, type: Model}
implementation:
  container:
    image: gurpreetgandhi/nesy-factory:v1
    command:
      - sh
      - -c
      - |
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import json
        import os
        import pickle
        import sys
        import torch
        import requests
        import io
        
        
        from nesy_factory.RNNs.simple_rnn import SimpleRNN
        from nesy_factory.RNNs.gru import GRU

        parser = argparse.ArgumentParser()
        parser.add_argument('--config', type=str, required=True)
        parser.add_argument('--model', type=str, required=True)
        parser.add_argument('--weights_url', type=str, default='-1')
        args = parser.parse_args()
        args.weights_url = args.weights_url.replace("$$", "$$$")
        config = json.loads(args.config)

        model_config = {
            'input_dim': len(config['feature_columns']),
            'hidden_dim': config['hidden_dim'],
            'output_dim': 1,
            'num_layers': config['num_layers'],
            'dropout': config['dropout'],
            'optimizer': 'adam',
            'learning_rate': config['learning_rate'],
            'epochs': config['epochs'],
            'loss_function': config['loss_function'],
            'device':config['device']
        }

        if config['model_type'] == 'SimpleRNN':
            model_obj = SimpleRNN(model_config)
        elif config['model_type'] == 'GRU':
            model_obj = GRU(model_config)
        else:
            raise ValueError("Invalid model type specified")
        
        # Ensure model and its parameters are on the correct device
        model_obj.to(config['device'])

        if args.weights_url != '-1':
            print(f"Downloading weights from {args.weights_url}")
            try:
                # Use a request session with retries/timeout for robustness
                response = requests.get(args.weights_url, timeout=60)
                response.raise_for_status()
                # Use io.BytesIO to load the model from memory without saving to disk
                buffer = io.BytesIO(response.content)
                state_dict = torch.load(buffer, map_location=torch.device('cpu'))
                model_obj.load_state_dict(state_dict)
                print("Successfully loaded weights from URL.")
            except requests.exceptions.RequestException as req_e:
                print(f"Warning: Failed to download weights from URL: {args.weights_url}. Request Error: {req_e}")
            except Exception as e:
                print(f"Warning: Failed to load weights from downloaded content. Error: {e}")
            # Continue without loading weights if download/load fails

        os.makedirs(os.path.dirname(args.model), exist_ok=True)
        with open(args.model, "wb") as f:
            pickle.dump(model_obj, f)

        print(f"Saved model to {args.model}")
    args:
      - --config
      - {inputValue: config}
      - --weights_url
      - {inputValue: weights_url}
      - --model
      - {outputPath: model}
