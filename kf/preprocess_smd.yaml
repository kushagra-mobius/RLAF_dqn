name: Preprocess SMD data
description: Takes raw SMD data, runs the preprocessing script, and outputs a zipped folder with the processed data.
inputs:
  - {name: train_data, type: Dataset}
  - {name: test_data, type: Dataset}
  - {name: anomaly_data, type: Dataset}
outputs:
  - {name: processed_data_zip, type: Dataset}
implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        set -e
        apt-get update && apt-get install -y git zip
        pip install pandas scikit-learn

        # Clone the repository that contains the generate_training_data.py script
        git clone https://github.com/huankoh/CST-GL
        cd CST-GL

        # The input data from the previous component will be available at these paths
        # We need to move them to where the script expects them.
        mkdir -p generate_data
        echo "--- Before moving input files ---"
        ls -l "$0"
        ls -l "$1"
        ls -l "$2"
        mv "$0"/data/machine-1-1_train.pkl generate_data/machine-1-1_train.pkl
        mv "$1"/data/machine-1-1_test.pkl generate_data/machine-1-1_test.pkl
        mv "$2"/data/machine-1-1_test_label.pkl generate_data/machine-1-1_test_label.pkl
        echo "--- After moving input files (contents of generate_data) ---"
        ls -l generate_data

        # The script has a bug, fix it with sed
        sed -i 's/train\.append(\[/pd.concat([train,/g' generate_data/generate_training_data.py

        # Create the output directory for the script
        mkdir -p data/machine-1-1

        # Run the preprocessing script
        python generate_data/generate_training_data.py \
          --output_dir 'data/machine-1-1' \
          --train_path 'generate_data/machine-1-1_train.pkl' \
          --test_path 'generate_data/machine-1-1_test.pkl' \
          --anomaly_path 'generate_data/machine-1-1_test_label.pkl' \
          --window_size 100 \
          --val_ratio 0.3

        # Zip the output directory
        echo "--- Before zipping (contents of data/machine-1-1) ---"
        ls -l data/machine-1-1
        zip -r processed_data.zip data/machine-1-1
        echo "--- After zipping (contents of current directory) ---"
        ls -l .
        # Move the zip file to the output path
        echo "--- Before moving zip to output path ---"
        ls -l processed_data.zip
        mv processed_data.zip "$3"/data

    args:
      - {inputPath: train_data}
      - {inputPath: test_data}
      - {inputPath: anomaly_data}
      - {outputPath: processed_data_zip}
